--- grbl-master/nuts_bolts.h	2015-07-17 07:19:57.000000000 -0700
+++ grbl-master/nuts_bolts.h	2015-07-30 13:54:25.576940724 -0700
@@ -22,6 +22,8 @@
 #ifndef nuts_bolts_h
 #define nuts_bolts_h
 
+#include "irq.h"
+
 #define false 0
 #define true 1
 
@@ -42,7 +44,7 @@
 // Conversions
 #define MM_PER_INCH (25.40)
 #define INCH_PER_MM (0.0393701)
-#define TICKS_PER_MICROSECOND (F_CPU/1000000)
+//#define TICKS_PER_MICROSECOND (F_CPU/1000000)
 
 // Useful macros
 #define clear_vector(a) memset(a, 0, sizeof(a))
@@ -53,9 +55,9 @@
 
 // Bit field and masking macros
 #define bit(n) (1 << n) 
-#define bit_true_atomic(x,mask) {uint8_t sreg = SREG; cli(); (x) |= (mask); SREG = sreg; }
-#define bit_false_atomic(x,mask) {uint8_t sreg = SREG; cli(); (x) &= ~(mask); SREG = sreg; }
-#define bit_toggle_atomic(x,mask) {uint8_t sreg = SREG; cli(); (x) ^= (mask); SREG = sreg; }
+#define bit_true_atomic(x,mask) {uint32_t saved = disable_irq(); (x) |= (mask); restore_irq(saved);}
+#define bit_false_atomic(x,mask) {uint32_t saved = disable_irq(); (x) &= ~(mask); restore_irq(saved);}
+#define bit_toggle_atomic(x,mask) {uint32_t saved = disable_irq(); (x) ^= (mask); restore_irq(saved);}
 #define bit_true(x,mask) (x) |= (mask)
 #define bit_false(x,mask) (x) &= ~(mask)
 #define bit_istrue(x,mask) ((x & mask) != 0)
